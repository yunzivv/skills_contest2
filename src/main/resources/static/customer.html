<!DOCTYPE html>
<html lang="kr">
<head>
    <meta charset="UTF-8">
    <title>고객 조회</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>
<body style="margin: 0; padding: 0;">
<div style="width: 100vw; height: 100vh; display: flex; position: relative; justify-content: center; align-items: center; background-color: #eeeeee;">
    <div style="width: 60%; height: 80%;
        text-align: center; padding: 20px;
        border-radius: 10px; background-color: white;">

        <!--search-->
        <div style="height:50px; display: flex; justify-content: center; align-items: center; gap: 10px;">
            성명
            <form id="searchForm" action="/api/customer" method="GET">
                <input name="keyword" type="text" style="padding:8px 20px; margin-right: 5px;">
                <button type="submit"
                        style="background:#dfdfdf; border-radius:10px; border:none; font-size:1rem;">
                    조회
                </button>
            </form>

            <button id="all"
                    style="background-color:#dfdfdf; border-radius:10px; border: none; font-size:1rem;">
                전체보기
            </button>
            <button id="update"
                    style="background-color:#dfdfdf; border-radius:10px; border: none; font-size:1rem;">
                수정
            </button>
            <button id="delete"
                    style="background-color:#dfdfdf; border-radius:10px; border: none; font-size:1rem;">
                삭제
            </button>
            <a href="/management.html"
               style="display:inline-block; background-color:#dfdfdf; border-radius:10px;
               padding: 10px 20px; text-decoration:none; color:#111;">
                닫기
            </a>
        </div>

        <!--list-->
        <div id="customer_container" style="overflow-y: auto; height: calc(80vh - 50px);">
        </div>

        <!-- update modal -->
        <div id="updateModal" class="hidden"
             style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5);">
            <div style="position: absolute; display: flex; flex-direction: column;
            top: calc(50% - 200px); left: calc(50% - 300px); width: 600px; height: 400px;
                background-color: #dddddd; border: gray solid 1px; border-radius: 10px; overflow: hidden;">
                <div style="text-align: right; background-color: #ffffff;">
                    <button onclick="closeModal('updateModal')"
                            style="background-color: #fd2f2f; color: white; border: gray solid 1px; padding: 5px 10px;">
                        x
                    </button>
                </div>
                <div style="flex-grow: 1; display: flex; flex-direction: column;">
                    <form id="updateForm" action="/api/customer" method="POST" onsubmit="updateCustomer(event);"
                          style="display: flex; flex-direction: column; height: 100%">
                        <ul style="margin: 5px 0;">
                            <li>
                                <div style="width: 50%">고객코드:</div>
                                <input type="text" id="code" name="code" readonly>
                            </li>
                            <li>
                                <div style="width: 50%">고 객 명:</div>
                                <input type="text" id="name" name="name" readonly>
                            </li>
                            <li>
                                <div style="width: 50%">생년월일:</div>
                                <input type="date" id="birth" name="birth">
                            </li>
                            <li>
                                <div style="width: 50%">연 락 처:</div>
                                <input type="tel" id="tel" name="tel">
                            </li>
                            <li>
                                <div style="width: 50%">주 소:</div>
                                <input type="text" id="address" name="address">
                            </li>
                            <li>
                                <div style="width: 50%">회 사 명:</div>
                                <input type="text" id="company" name="company">
                            </li>
                        </ul>
                        <div style="display: flex; gap: 10px; align-items: center; justify-content: center;
                                    flex-grow: 1;">
                            <button type="submit" style="padding: 10px 20px;">
                                수정
                            </button>
                            <button type="button" onclick="closeModal('updateModal')" style="padding: 10px 20px;">
                                취소
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>


        <style>
            ul, a {
                list-style: none;
                text-decoration: none;
                margin: 0;
                padding: 0;
            }

            button {
                padding: 10px 20px;
            }

            .selected {
                background-color: #c8dfff;
            }

            .hidden {
                display: none;
            }

            #updateForm li {
                display: flex;
                width: 100%;
                height: 50px;
                text-align: left;
                align-items: center;
                box-sizing: border-box;
                padding: 5px;
            }

            #updateForm li input {
                height: 100%;
                width: 50%;
                padding: 0;
                margin: 0;
            }
        </style>

        <!-- query -->
        <script>
            let selectedCustomer = null;
            const tableContainer = document.getElementById('customer_container');
            const searchForm = document.getElementById('searchForm');
            const btnAll = document.getElementById('all');

            async function loadCustomers(keyword) {
                const loadRq = keyword && keyword.trim()
                    ? `${searchForm.action}?keyword=${encodeURIComponent(keyword.trim())}`
                    : searchForm.action;

                const res = await fetch(loadRq, {method: 'GET'});
                const rows = await res.json();
                renderTable(rows);
            }

            function renderTable(rows) {

                let html = '<table id="customer_table" style="width:100%; border-collapse:collapse;">';
                html += '<thead style="position: sticky;"><tr>';
                ['code', 'name', 'birth', 'tel', 'address', 'company'].forEach(h => {
                    html += `<th style="border-bottom:1px solid #ddd; padding:8px; text-align:center;">${h}</th>`;
                });
                html += '</tr></thead><tbody>';

                for (const r of rows) {
                    html += '<tr style="cursor: pointer">';
                    html += `<td class="code" style="border-bottom:1px solid #f0f0f0; padding:8px 0;">${r.code}</td>`;
                    html += `<td class="name" style="border-bottom:1px solid #f0f0f0; padding:8px 0;">${r.name}</td>`;
                    html += `<td class="birth" style="border-bottom:1px solid #f0f0f0; padding:8px 0;">${(r.birth).toString().substring(0, 10)}</td>`;
                    html += `<td class="tel" style="border-bottom:1px solid #f0f0f0; padding:8px 0;">${r.tel ?? ''}</td>`;
                    html += `<td class="address" style="border-bottom:1px solid #f0f0f0; padding:8px 0;">${r.address ?? ''}</td>`;
                    html += `<td class="company" style="border-bottom:1px solid #f0f0f0; padding:8px 0;">${r.company ?? ''}</td>`;
                    html += '</tr>';
                }
                html += '</tbody></table>';
                tableContainer.innerHTML = html;
            }

            searchForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const kw = new FormData(searchForm).get('keyword') || '';
                loadCustomers(kw);
            });

            btnAll.addEventListener('click', () => loadCustomers());
            loadCustomers();

            <!-- click -->
            $(document).on("click", "#customer_table tr", function () {

                let code = $(this).find('td')[0].textContent;
                let name = $(this).find('td')[1].textContent;
                let birth = $(this).find('td')[2].textContent;
                let tel = $(this).find('td')[3].textContent;
                let address = $(this).find('td')[4].textContent;
                let company = $(this).find('td')[5].textContent;

                selectedCustomer = {
                    code,
                    name,
                    birth,
                    tel,
                    address,
                    company
                }

                $(this).siblings().removeClass('selected');
                $(this).addClass("selected");
            });

            <!-- update -->
            $('#update').click(function () {

                if (selectedCustomer !== null) {

                    $('#updateModal').removeClass('hidden');

                    $('#code').val(selectedCustomer.code);
                    $('#name').val(selectedCustomer.name);
                    $('#tel').val(selectedCustomer.tel);
                    $('#birth').val(selectedCustomer.birth);
                    $('#address').val(selectedCustomer.address);
                    $('#company').val(selectedCustomer.company);
                }
            });

            async function updateCustomer(event) {
                if (event) {
                    event.preventDefault();
                }

                const formEl = document.getElementById('updateForm');
                const formData = new FormData(formEl);

                const updateRes = await fetch('/api/customer', {
                    method: 'POST',
                    body: formData
                });

                const updateRs = await updateRes.json();

                if (updateRs) {
                    alert("고객 수정이 완료되었습니다.")
                    closeModal("updateModal");
                    await loadCustomers();
                } else alert("입력을 확인해주세요.");
            }

            // delete
            $('#delete').click(async function () {

                if (selectedCustomer !== null) {

                    if (confirm(selectedCustomer.name + "님을 정말 삭제하시겠습니까?")) {

                        const delRq = `/api/customer?code=${selectedCustomer.code}&name=${selectedCustomer.name}`;

                        const deleteRes = await fetch(delRq, {method: 'DELETE'});
                        const deleteRs = await deleteRes.json();
                        if(deleteRs) await loadCustomers();
                    }
                }
            });

            function closeModal(id) {
                $("#" + id).addClass('hidden');
            }

        </script>
    </div>
</div>
</body>
</html>