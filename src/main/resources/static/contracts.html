<!DOCTYPE html>
<html lang="kr">
<head>
    <meta charset="UTF-8">
    <title>계약 관리</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>
<body style="margin: 0; padding: 0;">
<div style="width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; background-color: #eeeeee;">
    <div style="width: 60%; height: 90%; text-align: center; padding: 20px 10px;
    display: flex; flex-direction: column; align-items:center; border-radius: 10px; background-color: white;">

        <form id="contractsForm" onsubmit="insertContract(event)"
              style="display: flex; flex-direction: column; justify-content: space-between; height: 30%; width: 100%;">
            <div style="display: flex; height: 70%; width: 80%;">
                <ul>
                    <li>
                        <div>고객코드:</div>
                        <input type="text" id="code" name="customerCode" readonly>
                    </li>
                    <li>
                        <div>고 객 명:</div>
                        <select id="name" onchange="fetchCustomer(this.value)">
                        </select>
                    </li>
                    <li>
                        <div>생년월일:</div>
                        <input type="date" id="birth" readonly>
                    </li>
                    <li>
                        <div>연 락 처:</div>
                        <input type="tel" id="tel" readonly>
                    </li>
                </ul>
                <ul>
                    <li>
                        <div>보험상품:</div>
                        <select id="contractName" name="contractName">
                        </select>
                    </li>

                    <li>
                        <div>가입금액:</div>
                        <input type="text" id="regPrice" name="regPrice">
                    </li>

                    <li>
                        <div>월보험료:</div>
                        <input type="text" id="monthPrice" name="monthPrice">
                    </li>
                </ul>
            </div>

            <div style="">
                담당자:
                    <select name="adminName" id="admin" style="padding: 10px 20px;"></select>
                <button type="submit">가입</button>
                <button type="button" id="deleteBtn">삭제</button>
                <button type="button" id="saveBtn">파일로 저장</button>
                <a href="/management.html"
                   style="display:inline-block; background-color: #efefef; border-radius:3px; font-size: 0.8rem;
               padding: 11px 20px; text-decoration:none; color:#111; border:1px solid #707070;">
                    닫기
                </a>
            </div>
        </form>
        <div style="width: 100%; ">
            <div style="margin: 20px 0;">< 고객 보험 계약 현황 ></div>
            <div id="contract_container" >
            </div>
        </div>

    </div>

    <style>
        ul {
            display: flex;
            flex-direction: column;
            width: 50%;
            height: 100%;
            list-style: none;
            text-decoration: none;
            margin: 0;
            padding: 0;
        }

        a:hover {
            background-color: #dddddd !important;
        }

        button {
            padding: 10px 20px;
        }

        ul > li {
            display: flex;
            flex-grow: 1;
            align-items: center;
        }

        ul > li > * {
            width: 50%;
            text-align: right;
            padding: 5px;
            margin: 2px;
            box-sizing: border-box;
        }

        ul > li > :last-child {
            align-self: stretch;
        }


    </style>

    <script>
        const formContainer = document.getElementById('contractsForm');
        const customerList = document.getElementById('name');
        const contractList = document.getElementById('contractName');
        const adminList = document.getElementById('admin');
        const contractContainer = document.getElementById('contract_container');

        let customerRows = null;
        let contractRows = null;

        // fetch select list
        async function fetchSelect() {

            // customer
            const customersRq = "/api/customer";
            const customersRes = await fetch(customersRq, {method: 'GET'});
            customerRows = await customersRes.json();

            let customerHtml = "";
            for (const [i, r] of customerRows.entries()) {
                customerHtml += `<option class="name" value="${i}">${r.name}</option>`;
            }
            await fetchCustomer(0);
            customerList.innerHTML = customerHtml;

            // contract
            const contractRq = "/api/contract";
            const contractRes = await fetch(contractRq, {method: 'GET'});
            const contractRows = await contractRes.json();

            let contractHtml = "";
            for (const r of contractRows) {
                contractHtml += `<option class="contractName" style="border-bottom:1px solid #f0f0f0; padding:8px 0;">${r.contractName}</option>`;
            }
            contractList.innerHTML = contractHtml;

            // admin
            const adminRq = "/api/admin";
            const adminRes = await fetch(adminRq, {method: 'GET'});
            const adminRows = await adminRes.json();

            let adminHtml = "";
            for (const r of adminRows) {
                adminHtml += `<option style="border-bottom:1px solid #f0f0f0; padding:8px 0;">${r.name}</option>`;
            }
            adminList.innerHTML = adminHtml;
        }

        fetchSelect()

        async function fetchCustomer(i) {

            const selectedCustomer = customerRows[i];

            $('#code').val(selectedCustomer.code);
            $('#birth').val(selectedCustomer.birth);
            $('#tel').val(selectedCustomer.tel);

            const contractsRq = `/api/contract/${selectedCustomer.code}`;
            const contractsRes = await fetch(contractsRq, {method: 'GET'});
            contractRows = await contractsRes.json();

            let html = '<table id="customer_table" style="width:100%; border-collapse:collapse;">';
            html += '<thead style="position: sticky;"><tr>';
            ['customerCode', 'contractName', 'regPrice', 'regDate', 'monthPrice', 'adminName'].forEach(h => {
                html += `<th style="border-bottom:1px solid #ddd; padding:8px; text-align:center; background-color: #eee;">${h}</th>`;
            });
            html += '</tr></thead><tbody>';

            for (const r of contractRows) {
                html += '<tr style="cursor: pointer">';
                html += `<td class="customerCode" style="border-bottom:1px solid #f0f0f0; padding:8px 0;">${r.customerCode}</td>`;
                html += `<td class="contractName" style="border-bottom:1px solid #f0f0f0; padding:8px 0;">${r.contractName}</td>`;
                html += `<td class="regPrice" style="border-bottom:1px solid #f0f0f0; padding:8px 0;">${(r.regPrice).toString().substring(0, 10)}</td>`;
                html += `<td class="regDate" style="border-bottom:1px solid #f0f0f0; padding:8px 0;">${r.regDate ?? ''}</td>`;
                html += `<td class="monthPrice" style="border-bottom:1px solid #f0f0f0; padding:8px 0;">${r.monthPrice ?? ''}</td>`;
                html += `<td class="adminName" style="border-bottom:1px solid #f0f0f0; padding:8px 0;">${r.adminName ?? ''}</td>`;
                html += '</tr>';
            }
            html += '</tbody></table>';
            contractContainer.innerHTML = html;
        }

        async function insertContract(event) {
            if (event) {
                event.preventDefault();
            }
            const formData = new FormData(formContainer);
            const insertRes = await fetch('/api/contract', {
                method: 'POST',
                body: formData
            });

            const insertRs = await insertRes.json();

            if(insertRs === true){
                fetchCustomer($("#name").val());
            }
        }

    </script>

</div>
</body>
</html>