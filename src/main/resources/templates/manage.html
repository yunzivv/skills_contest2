<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>식권 발매 프로그램</title>
    <link rel="stylesheet" href="/global.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>

<div class="manage_wrap">

    <!--manage-->
    <div class="manage_popup">
        <div>
            <button id="register_menu_btn">메뉴 등록</button>
            <button id="manage_menu_btn">메뉴 관리</button>
            <button id="payment_check_btn">결제 조회</button>
            <button id="chart_btn">종류별 차트</button>
            <button id="cls_btn">종 료</button>
        </div>
        <div>
            <img src="/img/main.jpg" alt="manage image">
        </div>
    </div>

    <!--film-->
    <div class="film hidden"></div>

    <!--register menu-->
    <form class="register_menu_popup hidden">

        <input type="hidden" value="0" name="mealNo" id="mealNo">

        <label for="cuisine">종류</label>
        <select name="cuisine" id="cuisine">
            <option value="1">한식</option>
            <option value="2">중식</option>
            <option value="3">일식</option>
            <option value="4">양식</option>
        </select>

        <div>*메뉴명</div>
        <input type="text" name="mealName" id="mealName">

        <label>가격</label>
        <select name="price" id="price">
            <option value="">선택</option>
        </select>


        <label>조리가능수량</label>
        <select name="maxCount" id="maxCount">
            <option value="">선택</option>
        </select>

        <button type="submit">등록</button>
        <button class="cls_popup_btn" type="button">닫기</button>
    </form>

    <!--manage menu-->
    <div class="manage_menu_popup hidden">
        <div class="manage_menu_btn">
            <label for="search_cuisine">종류: </label>
            <select name="종류" id="search_cuisine">
                <option value="0" selected>전체</option>
                <option value="1">한식</option>
                <option value="2">중식</option>
                <option value="3">일식</option>
                <option value="4">양식</option>
            </select>
            <button id="cuisine_search_btn">검색</button>
            <button id="menu_edit_btn">수정</button>
            <button id="menu_delete_btn">삭제</button>
            <button id="todayMeal_btn">오늘의 메뉴 선정</button>
            <button class="cls_popup_btn" type="button">닫기</button>
        </div>
        <form action="" class="manage_menu_form">
            <table class="meal_table">
                <thead>
                <tr>
                    <th><input type="checkbox" id="check_all"></th>
                    <th>menuName</th>
                    <th>price</th>
                    <th>maxCount</th>
                    <th>todayMeal</th>
                </tr>
                </thead>

                <tbody id="meal_list">
                </tbody>
            </table>
        </form>
    </div>

    <!--payment check-->
    <div class="payment_check_popup hidden">
        <div class="payment_menu_btn">
            <label for="keyword">메뉴명</label>
            <input type="text" id="keyword">
            <button id="search_btn">조회</button>
            <button id="refresh_btn">새로고침</button>
            <button id="print_btn">인쇄</button>
            <button class="cls_popup_btn" type="button">닫기</button>
        </div>
        <form action="" class="payment_menu_form">
            <table class="meal_table">
                <thead>
                <tr>
                    <th>종류</th>
                    <th>메뉴명</th>
                    <th>사원명</th>
                    <th>결제수량</th>
                    <th>총결제금액</th>
                    <th>결제일</th>
                </tr>
                </thead>

                <tbody id="payment_list">
                </tbody>
            </table>
        </form>
    </div>

    <!--chart-->
    <div class="chart_popup hidden">
        <div class="chart_btn">
            <button class="saveChart_btn">차트 이미지 저장</button>
            <button class="cls_popup_btn">닫기</button>
        </div>
        <div class="chart_container">
            <canvas id="chart"></canvas>
        </div>
    </div>
</div>


<script>
    /** 1차 메뉴 초기 렌더링 **/
    // 메뉴 등록
    function renderOptions() {
        const priceSelect = document.getElementById("price");
        for (let price = 1000; price <= 12000; price += 500) {
            const option = document.createElement("option");
            option.value = price;
            option.textContent = price.toLocaleString();
            priceSelect.appendChild(option);
        }

        const maxCountSelect = document.getElementById("maxCount");
        for (let maxCount = 0; maxCount <= 50; maxCount++) {
            const option = document.createElement("option");
            option.value = maxCount;
            option.textContent = maxCount;
            maxCountSelect.appendChild(option);
        }
    }

    // 메뉴 관리
    function renderMeals(meals) {
        let html = "";

        meals.forEach(m => {
            html += `
                <tr>
                    <td>
                    <input type="checkbox"
                                   class="meal-check"
                                   data-mealno="${m.mealNo}"
                                   data-cuisineno="${m.cuisineNo}"
                                   data-mealname="${m.mealName}"
                                   data-price="${m.price}"
                                   data-maxcount="${m.maxCount}">
                    </td>
                    <td>${m.mealName}</td>
                    <td>${m.price.toLocaleString()}</td>
                    <td>${m.maxCount}</td>
                    <td>${m.todayMeal ? 'Y' : 'N'}</td>
                </tr>
            `;
        });
        document.getElementById("meal_list").innerHTML = html;
    }

    function loadMeals(cuisine) {
        $.ajax({
            url: "/getMeals",
            type: "GET",
            data: {cuisine: cuisine},
            success: function (meals) {
                renderMeals(meals);
            },
            error: function () {
                alert("서버 오류");
            }
        });
    }

    // 결제 관리
    function renderOrders(orders) {
        let html = "";

        orders.forEach(o => {
            html += `
                <tr>
                    <td>${o.cuisineName}</td>
                    <td>${o.mealName}</td>
                    <td>${o.memberName}</td>
                    <td>${o.orderCount}</td>
                    <td>${o.amount}</td>
                    <td>${o.orderDate}</td>
                </tr>
            `;
        });
        document.getElementById("payment_list").innerHTML = html;
    }

    function loadOrders(keyword) {
        $.ajax({
            url: "/getOrders",
            type: "GET",
            data: {keyword: keyword},
            success: function (orders) {
                renderOrders(orders);
            },
            error: function () {
                alert("서버 오류");
            }
        });
    }

    // 차트
    function renderChart(chartObjects) {
        const labels = chartObjects.map(item => item.cuisineName);
        const data = chartObjects.map(item => item.cnt);

        function randomColor(i, total) {
            return `hsl(${Math.floor((360 / total) * i)}, 70%, 60%)`;
        }

        const colors = data.map((_, i) => randomColor(i, data.length));

        Chart.register(Chart.ArcElement, Chart.Tooltip, Chart.Legend);
        const ctx = document.getElementById('chart').getContext('2d');

        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors
                }]
            },
            options: {
                layout: {
                    padding: 0
                },
                plugins: {
                    title: {
                        display: true,
                        text: '종류별 결제건수 통계차트',
                        font: { size: 15 },
                        padding: { bottom: 20 }
                    },
                    legend: {
                        position: 'right',
                        fullSize: false,
                        labels: {
                            boxWidth: 14,
                            padding: 10,
                            font: {
                                size: 12
                            },
                            usePointStyle: false,
                            generateLabels(chart) {
                                const { data } = chart.data.datasets[0];
                                return chart.data.labels.map((label, i) => {
                                    return {
                                        text: `${label} (${data[i]}건)`,
                                        fillStyle: colors[i],
                                        strokeStyle: colors[i],
                                        lineWidth: 1,
                                        hidden: chart.getDatasetMeta(0).data[i].hidden,
                                        index: i
                                    };
                                });
                            }
                        }
                    }
                },
                maintainAspectRatio: false,
                responsive: true,
            }
        });
    }
    function loadChart() {
        $.ajax({
            url: "/getChart",
            type: "GET",
            success: function (chart) {
                renderChart(chart);
            },
            error: function () {
                alert("서버 오류");
            }
        });
    }

</script>

<script>
    /** 사용자 요청 함수 **/
    $(document).ready(function () {

        // 전역변수
        let selectedIds = [];
        let selectedMeal = {};

        // 메뉴
        function updateView(key) {
            $(".manage_wrap > *").addClass("hidden");
            switch (key) {
                case 'register':
                    renderOptions();
                    $(".register_menu_popup").removeClass("hidden");
                    break;
                case 'manage':
                    loadMeals(0);
                    $(".manage_menu_popup").removeClass("hidden");
                    break;
                case 'payment':
                    loadOrders("");
                    $(".payment_check_popup").removeClass("hidden");
                    break;
                case 'chart':
                    loadChart();
                    $(".chart_popup").removeClass("hidden");
                    break;
                default:
                    $(".manage_popup").removeClass("hidden");
                    break;
            }
        }

        $(window).on('hashchange', function () {
            const key = window.location.hash.substring(1);
            updateView(key);
        });
        $(window).trigger('hashchange');

        $(".cls_popup_btn").click(() => {
            window.location.hash = '';
        });

        // 1차 메뉴
        $("#cls_btn").click(() => {
            window.location.href = "/";
        });
        $("#register_menu_btn").click(() => {
            window.location.hash = 'register';
        });
        $("#manage_menu_btn").click(() => {
            window.location.hash = 'manage';
        });
        $("#payment_check_btn").click(() => {
            window.location.hash = 'payment';
        });
        $("#chart_btn").click(() => {
            window.location.hash = 'chart';
        });

        // 2차: 메뉴 등록
        $(".register_menu_popup").submit(function (e) {
            e.preventDefault();
            if ($("#mealName").val().trim() === "") {
                alert("메뉴명을 입력해주세요.");
                return;
            }

            const mealNo = $("#mealNo").val();
            const isRegister = mealNo === "0";

            $.ajax({
                url: "/registerMenu",
                type: "POST",
                data: $(this).serialize(),
                success: function (result) {
                    if (result === true) {
                        if (isRegister) {
                            alert("메뉴가 정상적으로 등록되었습니다.");
                            $(".register_menu_popup")[0].reset();
                            loadMeals(0);
                        } else {
                            alert("메뉴가 정상적으로 수정되었습니다.");
                            $("#mealNo").val(0);
                            $(".film").addClass("hidden");
                            window.location.hash = 'manage';
                        }
                    } else {
                        alert(isRegister ? "메뉴 등록에 실패했습니다." : "메뉴 수정에 실패했습니다.");
                    }
                },
                error: () => alert("서버 오류")
            });
        });

        // 2차: 메뉴 관리
        $(document).on("change", "input.meal-check", function () {
            const id = $(this).data("mealno");
            if (this.checked) {
                if (selectedIds.length >= 25) {
                    alert("25개를 초과할 수 없습니다.");
                    $(this).prop("checked", false);
                    return;
                }
                selectedMeal = {
                    mealNo: id,
                    cuisineNo: $(this).data("cuisineno"),
                    mealName: $(this).data("mealname"),
                    price: $(this).data("price"),
                    maxCount: $(this).data("maxcount")
                };
                selectedIds.push(id);
            } else {
                selectedIds = selectedIds.filter(item => item !== id);
            }
        });
        $("#cuisine_search_btn").click(() => {
            loadMeals($("#search_cuisine").val());
        });
        $("#check_all").on("change", function () {
            const checked = $(this).is(":checked");
            const checkboxes = $("#meal_list input[type='checkbox']");
            checkboxes.prop("checked", checked);

            selectedIds = [];
            if (checked) {
                checkboxes.each(function () {
                    selectedIds.push($(this).data("mealno"));
                });
            } else {
                selectedMeal = {};
            }
        });
        $("#menu_edit_btn").click(function () {
            if (selectedIds.length !== 1) {
                alert(selectedIds.length === 0 ? "수정할 메뉴를 선택해주세요." : "하나씩 수정 가능합니다.");
                return;
            }
            $(".film").removeClass("hidden");

            setTimeout(() => {
                $("#mealNo").val(selectedMeal.mealNo);
                $("#cuisine").val(selectedMeal.cuisineNo);
                $("#mealName").val(selectedMeal.mealName);
                $("#price").val(selectedMeal.price);
                $("#maxCount").val(selectedMeal.maxCount);
            }, 0);

            window.location.hash = 'register';
        });
        $("#menu_delete_btn").click(function () {
            if (selectedIds.length === 0) {
                alert("삭제할 메뉴를 선택해주세요.");
                return;
            }
            $.ajax({
                url: "/deleteMeal",
                type: "DELETE",
                traditional: true,
                data: {mealNos: selectedIds},
                success: function (result) {
                    if (result) {
                        alert("삭제가 완료되었습니다.");
                        selectedIds = [];
                        selectedMeal = {};
                        loadMeals($("#search_cuisine").val() || 0);
                    } else {
                        alert("삭제를 실패했습니다.");
                    }
                },
                error: () => alert("서버 오류")
            });
        });
        $("#todayMeal_btn").click(function () {
            if (selectedIds.length === 0) {
                alert("오늘의 메뉴로 선정할 메뉴를 선택해주세요.");
                return;
            }
            $.ajax({
                url: "/todayMeals",
                type: "POST",
                traditional: true,
                data: {mealNos: selectedIds},
                success: function (result) {
                    if (result) {
                        loadMeals($("#search_cuisine").val() || 0);
                        alert("오늘의 메뉴가 설정되었습니다.");
                        selectedIds = [];
                    } else {
                        alert("오늘의 메뉴 설정에 실패했습니다.");
                    }
                },
                error: () => alert("서버 오류")
            });
        });

        // 2차: 결제 조회
        $("#search_btn").click(function () {
            loadOrders($("#keyword").val());
        })
        $("#refresh_btn").click(function () {
            loadOrders("");
        })
        $("#print_btn").click(function () {
            window.print();
        })

        // 2차: 차트
        $(".saveChart_btn").click(function () {
            const el = document.querySelector(".chart_container");
            html2canvas(el).then(c => {
                const d = new Date();
                const pad = n => String(n).padStart(2, "0");
                const name = `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}-종류별결제현황차트.jpg`;
                c.toBlob(b => {
                    const a = document.createElement("a");
                    a.href = URL.createObjectURL(b);
                    a.download = name;
                    a.click();
                }, "image/jpeg");
            });
        });

    });
</script>
</body>
</html>
